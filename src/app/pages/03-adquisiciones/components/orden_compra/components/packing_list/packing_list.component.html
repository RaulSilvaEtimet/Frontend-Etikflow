<app-blocked-send-info-database [blockedPanel]="blockedSendInfo"></app-blocked-send-info-database>
<app-blocked-get-info-database [blockedPanel]="blockedGetInfo"></app-blocked-get-info-database>
<p-card header="Ingreso de Packing List">
    <div class="grid">
        <p-fieldset legend="Proveedores" class="col-12 md:col-6">
            <div class="flex flex-column gap-3">
                <div class="flex align-items-center gap-3">
                    <label for="proveedor" class="font-semibold w-12rem">Proveedor</label>
                    <div class="flex-auto">
                        <b class="font-semibold flex-auto text-xl">{{compraService.cabecera.RazonSocialProveedor}}</b>
                    </div>
                </div>
                <div class="flex align-items-center gap-3">
                    <label for="proveedor" class="font-semibold w-12rem">NIT</label>
                    <b class="font-semibold flex-auto text-xl">{{compraService.cabecera.IdentificacionProveedor}}</b>
                </div>
                <div class="flex align-items-center gap-3">
                    <label for="proveedor" class="font-semibold w-12rem">Dirección</label>
                    <b class="font-semibold flex-auto text-xl">{{compraService.cabecera.DirecionProveedor}}</b>
                </div>
            </div>
        </p-fieldset>
        <p-fieldset legend="Información" class="col-12 md:col-6">
            <div class="flex flex-column gap-3">
                <div class="flex align-items-center gap-3 mb-3">
                    <label for="proveedor" class="font-semibold w-10rem">Fecha creacion</label>
                    <b class="font-semibold flex-auto text-xl">
                        {{compraService.cabecera.FechaRegistroOrdenCompra| date:"EEEE, d MMMy"}}
                    </b>
                </div>
            </div>
            <div class="flex flex-column gap-3">
                <div class="flex align-items-center gap-3 mb-3">
                    <label for="proveedor" class="font-semibold w-10rem">Fecha entrega</label>
                    <b class="font-semibold flex-auto text-xl">
                        {{compraService.cabecera.FechaEntrega | date: "EEEE, d MMM y"}}
                    </b>
                </div>
            </div>
            <div class="flex">
                <div class="flex align-items-center gap-3">
                    <label for="proveedor" class="font-semibold w-10rem">Plazo días</label>
                    <b class="font-semibold flex-auto text-xl">
                        {{compraService.cabecera.Plazo}}
                    </b>
                </div>
            </div>
        </p-fieldset>
        <p-fieldset legend="Detalle" class="col-12 md:col-12">
            <p-table #dtData [value]="compraService.detalles" [tableStyle]="{'min-width': '10rem'}"
                styleClass="p-datatable-sm" [responsive]="true" [scrollable]="true" scrollDirection="horizontal">
                <ng-template pTemplate="caption">
                    <div class="flex justify-content-between">
                        <div></div>
                        <div>
                            <table class="text-right">
                                <tr>
                                    <td class="semibold">Total KG:</td>
                                    <td class="ml-3">
                                        <b>{{pesoTotal | number: '1.2-2'}}</b>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Total M2:</td>
                                    <td class="ml-3">
                                        <b>{{metrosCuadradosTotal | number: '1.2-2'}}</b>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="mr-6">
                            <table class="text-right">
                                <tr>
                                    <td>Subtotal:</td>
                                    <td class="ml-3">
                                        <b>{{valorSubtotal | number : '1.2-2'}}</b>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Iva:</td>
                                    <td class="ml-3">
                                        <b>{{valorIva | number : '1.2-2'}}</b>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-right">Neto:</td>
                                    <td class="ml-3">
                                        <b>{{valorTotal | number : '1.2-2'}}</b>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </ng-template>
                <ng-template pTemplate="header" let-columns>
                    <tr>
                        <th style="min-width:100px">Acciones</th>
                        <th style="min-width:75px">Num</th>
                        <th style="min-width:500px">Descripción</th>
                        <th style="min-width:100px">Código interno</th>
                        <th style="min-width:100px">Bobinas</th>
                        <th style="min-width:100px">Ancho</th>
                        <th style="min-width:100px">Largo</th>
                        <th style="min-width:100px" class="text-right">M2</th>
                        <th style="min-width:100px" class="text-right">Kg</th>
                        <th style="min-width:100px" class="text-right">Precio</th>
                        <th style="min-width:100px" class="text-right">Subtotal</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
                    <tr>
                        <td class="flex gap-2 justify-content-center">
                            <p-button *ngIf="listCheck[rowIndex]" icon="fa-solid fa-check" [raised]="true"
                                severity="success" pTooltip="Aceptar" tooltipPosition="bottom"
                                (onClick)="onCheckNewDetalle(item, rowIndex)"></p-button>
                            <p-button icon="fa-solid fa-pencil" [raised]="true" severity="primary" pTooltip="Editar"
                                tooltipPosition="bottom" (onClick)="onOpenModalEdit(item)"></p-button>
                        </td>
                        <td>{{rowIndex +1}}</td>
                        <td>{{item.DescripcionDetalleCompra}}</td>
                        <td>{{item.CodigoInternoSustrato }}</td>
                        <td>{{item.CantidadCompra}}</td>
                        <td>{{item.AnchoDetalleCompra}}</td>
                        <td>{{item.LargoDetalleCompra}}</td>
                        <td class="text-right">
                            {{item.CantidadDetalleCompra | number : '1.2-2'}}
                        </td>
                        <td class="text-right">
                            {{item.PesoProductoDetalleCompra | number: '1.2-2'}}
                        </td>
                        <td class="text-right">
                            {{item.ValorDetalleCompra | currency: 'USD':'symbol':'1.2-4'}}
                        </td>
                        <td class="text-right">
                            {{item.BaseIvaDetalleCompra | currency: 'USD':'symbol':'1.2-4'}}
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </p-fieldset>
        <p-fieldset legend="Packing List" class="col-12 md:col-12">
            <p-table #dtData [value]="compraService.packingList" [tableStyle]="{'min-width': '10rem'}"
                styleClass="p-datatable-sm" [responsive]="true" [scrollable]="true" scrollDirection="horizontal">
                <ng-template pTemplate="caption">
                    <div class="flex justify-content-between">
                        <div></div>
                        <div>
                            <table class="text-right">
                                <tr>
                                    <td class="semibold">Total KG:</td>
                                    <td class="ml-3">
                                        <b>{{newPesoTotal | number: '1.2-2'}}</b>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Total M2:</td>
                                    <td class="ml-3">
                                        <b>{{newMetrosCuadradosTotal | number: '1.2-2'}}</b>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="mr-6">
                            <table class="text-right">
                                <tr>
                                    <td>Subtotal:</td>
                                    <td class="ml-3">
                                        <b>{{compraService.cabecera.ValorBaseImponibleIva | number : '1.2-2'}}</b>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Iva:</td>
                                    <td class="ml-3">
                                        <b>{{compraService.cabecera.ValorIva | number : '1.2-2'}}</b>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-right">Neto:</td>
                                    <td class="ml-3">
                                        <b>{{compraService.cabecera.ValorTotal | number : '1.2-2'}}</b>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </ng-template>
                <ng-template pTemplate="header" let-columns>
                    <tr>
                        <th style="min-width:75px">Num</th>
                        <th style="min-width:500px">Descripción</th>
                        <th style="min-width:100px">Código interno</th>
                        <th style="min-width:100px">Bobinas</th>
                        <th style="min-width:100px">Ancho</th>
                        <th style="min-width:100px" class="text-right">Largo</th>
                        <th style="min-width:100px" class="text-right">M2</th>
                        <th style="min-width:100px" class="text-right">Kg</th>
                        <th style="min-width:100px" class="text-right">Precio</th>
                        <th style="min-width:100px" class="text-right">Subtotal</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-detalle let-rowIndex="rowIndex">
                    <tr>
                        <td>{{rowIndex +1}}</td>
                        <td>{{detalle.DescripcionDetalleCompra}}</td>
                        <td>{{detalle.CodigoInternoSustrato }}</td>
                        <td>{{detalle.CantidadCompra}}</td>
                        <td>{{detalle.AnchoDetalleCompra}}</td>
                        <td class="text-right">
                            {{detalle.LargoDetalleCompra}}
                        </td>
                        <td class="text-right">
                            {{detalle.CantidadDetalleCompra | number : '1.2-2'}}
                        </td>
                        <td class="text-right">
                            {{detalle.PesoProductoDetalleCompra | number: '1.2-2'}}
                        </td>
                        <td class="text-right">
                            {{detalle.ValorDetalleCompra | number : '1.2-2'}}
                        </td>
                        <td class="text-right">
                            {{detalle.BaseIvaDetalleCompra | number : '1.2-2'}}
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </p-fieldset>
        <p-fieldset legend="Finalizar" class="col-12 md:col-12">
            <p-button icon="fa-solid fa-floppy-disk" label="Aceptar" severity="success"
                (onClick)="finalizar()"></p-button>
        </p-fieldset>
    </div>
</p-card>
<p-toast position="top-right"></p-toast>
<!--MODAL DE AGREGAR DETALLE-->
<p-dialog header="Actualizar cantidades" [modal]="true" [(visible)]="modalActCantidades" [style]="{ width: '60rem' }">
    <div class="mt-2 flex flex-column gap-3">
        <form [formGroup]="myForm" class="flex align-items-center gap-3">
            <label for="largoTotal" class="font-semibold w-8rem">Largo total m2</label>
            <p-inputNumber [minFractionDigits]="2" mode="decimal" locale="en-US" currency="USD" [min]="0"
                formControlName="newLargo" (ngModelChange)="onChangeMetrosTotales($event)" />
        </form>
        <p *ngIf="alertLargo" class="text-orange-500">Nota: Estas ingresando un valor diferente al original</p>
        <p-table [value]="newDetalle" editable="true" [tableStyle]="{'min-width': '10rem'}" styleClass="p-datatable-sm"
            [responsive]="true" [scrollable]="true" scrollDirection="horizontal">
            <ng-template pTemplate="caption">
                <p-button icon="fa-solid fa-plus" (click)="onAddNewDetalle()"></p-button>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 20%">Código interno</th>
                    <th style="width: 20%">Gramos</th>
                    <th style="width: 20%">Ancho</th>
                    <th style="width: 20%">Bobinas</th>
                    <th style="width: 20%">Largo</th>
                    <th style="width: 20%">Total</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-detalle let-ri="rowIndex" let-editing="editing">
                <tr>
                    <td>{{ detalle.CodigoInternoSustrato }}</td>
                    <td>{{ detalle.PesoDetalleCompra }}</td>
                    <td>{{ detalle.AnchoDetalleCompra }}</td>
                    <td pEditableColumn>
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <p-inputNumber [minFractionDigits]="0" mode="decimal" locale="en-US" currency="USD"
                                    [min]="0" [(ngModel)]="detalle.CantidadCompra"
                                    (ngModelChange)="onCalculateM2(detalle)" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ detalle.CantidadCompra }}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td pEditableColumn>
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <p-inputNumber [minFractionDigits]="0" mode="decimal" locale="en-US" currency="USD"
                                    [min]="0" [(ngModel)]="detalle.LargoDetalleCompra"
                                    (ngModelChange)="onCalculateM2(detalle)" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ detalle.LargoDetalleCompra }}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td class="text-right">
                        {{ detalle.CantidadDetalleCompra | number: '1.2-4' }}
                    </td>
                </tr>
            </ng-template>
        </p-table>
        <div class="flex justify-content-end gap-2">
            <p-button label="Guardar" severity="success" (onClick)="onSaveNewDetalle()" />
            <p-button label="Cerrar" severity="secondary" (onClick)="modalActCantidades = false" />
        </div>

    </div>
</p-dialog>