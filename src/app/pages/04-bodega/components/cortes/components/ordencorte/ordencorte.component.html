<app-blocked-send-info-database [blockedPanel]="blockedPanel"></app-blocked-send-info-database>
<div class="flex flex-column gap-3">
    <p-fieldset legend="Parametros de busqueda">
        <form [formGroup]="myForm" class="grid align-items-center" (ngSubmit)="onSearchKardex()">
            <div class="col-12 md:col-12 flex align-items-center gap-3">
                <label for="listSustrato" class="font-semibold w-12rem">Sustratos Inventario</label>
                <div class="flex-auto">
                    <p-dropdown id="listSustrato" [options]="listSustratos" placeholder="Escoja una opcion"
                        styleClass="w-full" [filter]="true"
                        [filterFields]="['CodigoInternoInventario','DescripcionInventario','TotalInventarioM2']"
                        [showClear]="true" filterPlaceholder="Buscando..." [virtualScroll]="true"
                        [virtualScrollItemSize]="20" [loading]="loadingInventario" formControlName="idInventario">
                        <ng-template let-sustratos pTemplate="selectedItem">
                            <div class="custom-dropdown-item">
                                {{ sustratos.CodigoInternoInventario }} - {{sustratos.DescripcionInventario}} -
                                {{sustratos.RazonSocialProveedor}}
                            </div>
                        </ng-template>
                        <ng-template let-prov pTemplate="item">
                            <div class="flex flex-column custom-dropdown-item">
                                <div>
                                    {{ prov.CodigoInternoInventario }} - {{prov.DescripcionInventario}}
                                </div>
                                <div>
                                    {{prov.RazonSocialProveedor}}
                                </div>
                                <div>
                                    {{prov.TotalInventarioM2}} m2
                                </div>
                            </div>
                        </ng-template>
                    </p-dropdown>
                </div>
            </div>
            <div class="col-12 md:col-3 flex align-items-center gap-3">
                <label for="" class="font-semibold w-12rem">Ancho Min:</label>
                <div class="flex-auto">
                    <p-inputNumber formControlName="anchoMin" [minFractionDigits]="0" mode="decimal" locale="es-EC"
                        [min]="0" />
                </div>
            </div>
            <div class="col-12 md:col-3 flex align-items-center gap-3">
                <label for="" class="font-semibold w-12rem">Ancho Max:</label>
                <div class="flex-auto">
                    <p-inputNumber formControlName="anchoMax" [minFractionDigits]="0" mode="decimal" locale="es-EC"
                        [min]="0" />
                </div>
            </div>
            <div class="col-12 md:col-3 flex align-items-center gap-3">
                <label for="" class="font-semibold w-12rem">Largo Min:</label>
                <div class="flex-auto">
                    <p-inputNumber formControlName="largoMin" [minFractionDigits]="0" mode="decimal" locale="es-EC"
                        [min]="0" />
                </div>
            </div>
            <div class="col-12 md:col-3 flex align-items-center gap-3">
                <label for="" class="font-semibold w-12rem">Largo Max</label>
                <div class="flex-auto">
                    <p-inputNumber formControlName="largoMax" [minFractionDigits]="0" mode="decimal" locale="es-EC"
                        [min]="0" />
                </div>
            </div>
            <div class="col-12 flex gap-3 justify-content-center">
                <p-button label=" Buscar" icon="fa-solid fa-magnifying-glass" severity="success" type="submit"
                    [loading]="loadingKardex" [disabled]="disabledElements"></p-button>
            </div>
        </form>
    </p-fieldset>
    <p-fieldset legend="Seleccionar cortes o bobinas" *ngIf="listkardex.length !== 0 || listSelectKardex.length !== 0">
        <div class="flex flex-column align-items-center gap-3">
            <p-pickList [source]="listkardex" [target]="listSelectKardex" sourceHeader="Disponibles"
                targetHeader="Escogidos" [dragdrop]="true" [responsive]="true"
                [sourceStyle]="{ height: '30rem', width: '40rem' }" [targetStyle]="{ height: '30rem', width: '40rem' }"
                filterBy="CodigoBarras" sourceFilterPlaceholder="Buscar bobina o corte"
                targetFilterPlaceholder="Buscar bobina o corte" breakpoint="1400px" [disabled]="disabledElements">
                <ng-template let-kardex pTemplate="item">
                    <div class="flex flex-wrap align-items-center gap-2">
                        <div class="flex">
                            @if(kardex.Lote === null || kardex.Lote === 'NO PROPORCIONADO' || kardex.Lote === '' ||
                            kardex.PesoMaterial === 0 || kardex.PesoTotal === 0){
                            <i class="fa-solid fa-circle text-red-500"></i>
                            } @else {
                            <i class="fa-solid fa-circle text-green-500"></i>
                            }
                        </div>
                        <div class="flex-1 flex flex-column gap-1">
                            <span class="font-bold">
                                {{ kardex.IdKardex }} - {{kardex.CodigoBarras}}
                            </span>
                            <div class="flex align-products-center gap-2">
                                <span>
                                    {{ kardex.Ancho }}mm * {{kardex.Largo}}m
                                </span>
                            </div>
                        </div>
                    </div>
                </ng-template>
            </p-pickList>
            <p-button label="Escoger" icon="fa-solid fa-clipboard-check" severity="success"
                (onClick)="onEscogerKardex()" [disabled]="disabledElements"></p-button>
        </div>
    </p-fieldset>
    <p-fieldset legend="Dimensionar cortes" *ngIf="disabledElements">
        <div class="grid justify-content-center">
            <div class="col-12 md:col-6">
                <p-table [value]="listParadas" [scrollable]="true">
                    <ng-template pTemplate="caption">
                        <div class="flex gap-2">
                            <p-button label="Generar orden corte" icon="fa-solid fa-floppy-disk" severity="success"
                                (onClick)="onFinalizar()" [disabled]="blockedPanel"></p-button>
                            <p-button label="Agregar parada" icon="fa-solid fa-plus" severity="primary"
                                (onClick)="onAddParada()"></p-button>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Parada</th>
                            <th>Largo</th>
                            <th>Anchos</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-parada>
                        <tr>
                            <td>{{ parada.Parada}}</td>
                            <td>{{ parada.Largo }}</td>
                            <td>{{ parada.Anchos}}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </p-fieldset>
</div>
<!--MODAL PARADAS-->
<p-dialog header="Crear datos de parada" [modal]="true" [(visible)]="modalAddParada" [style]="{ width: '30rem' }">
    <div class="mt-2 flex flex-column gap-2">
        <form [formGroup]="myFormParada" class="flex align-items-center gap-3">
            <label for=" largoParada" class="font-semibold w-7rem">Largo de la parada</label>
            <p-inputNumber formControlName="largoParada" id="largoParada" [minFractionDigits]="0" mode="decimal"
                locale="en-US" currency="USD" [min]="0" />
        </form>
        <p-table [value]="listAnchos" editable="true" [tableStyle]="{'min-width': '10rem'}" styleClass="p-datatable-sm"
            [responsive]="true" [scrollable]="true" scrollDirection="horizontal">
            <ng-template pTemplate="caption">
                <p-button icon="fa-solid fa-plus" (click)="onAddMedida()"></p-button>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 10%">#</th>
                    <th>Ancho (mm)</th>
                    <th>Cantidad</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-ancho let-ri="rowIndex" let-editing="editing">
                <tr>
                    <td>{{ ri+1 }}</td>
                    <td pEditableColumn>
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <p-inputNumber [minFractionDigits]="0" mode="decimal" locale="en-US" [min]="0"
                                    [(ngModel)]="ancho.Medida" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ ancho.Medida }}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td pEditableColumn>
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <p-inputNumber [minFractionDigits]="0" mode="decimal" locale="en-US" [min]="0"
                                    [(ngModel)]="ancho.Cantidad" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ ancho.Cantidad }}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                </tr>
            </ng-template>
        </p-table>
        <div class="flex justify-content-end gap-2">
            <p-button label="Guardar" severity="success" (onClick)="onSaveMedida()" />
            <p-button label="Cerrar" severity="secondary" (onClick)="modalAddParada = false" />
        </div>

    </div>
</p-dialog>